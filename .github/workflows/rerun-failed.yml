name: Rerun failed jobs

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  rerun:
    name: Rerun failed jobs
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'

    permissions:
      actions: write

    steps:
      - name: Rerun failed jobs with backoff
        uses: actions/github-script@v7
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const attempt = context.payload.workflow_run.run_attempt;
            const maxAttempts = 6;

            if (attempt >= maxAttempts) {
              core.warning(`Run ${run_id} at attempt ${attempt} â€” giving up after ${maxAttempts} attempts.`);
              return;
            }

            // Exponential backoff: 1m, 2m, 4m, 8m, 16m (total ~31m of spread)
            const delaySec = Math.pow(2, attempt - 1) * 60;
            const delayMin = delaySec / 60;
            console.log(`Run ${run_id} failed on attempt ${attempt}. Waiting ${delayMin}m before retry...`);

            await new Promise(resolve => setTimeout(resolve, delaySec * 1000));

            console.log(`Rerunning failed jobs for run ${run_id} (attempt ${attempt + 1} of ${maxAttempts})...`);
            await github.rest.actions.reRunWorkflowFailedJobs({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run_id,
            });
